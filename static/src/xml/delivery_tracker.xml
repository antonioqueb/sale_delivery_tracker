<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="sale_delivery_tracker.DeliveryTrackerWidget">
        <div class="dt-root">

            <t t-if="!state.lines.length">
                <div class="dt-empty">
                    <i class="fa fa-truck dt-empty-icon"></i>
                    <span>Sin entregas programadas</span>
                </div>
            </t>

            <t t-if="state.lines.length">

                <!-- Summary -->
                <div class="dt-summary">
                    <span class="dt-summary-label">Entregas</span>
                    <t t-if="state.summary.all_done">
                        <span class="dt-badge bg-done"><i class="fa fa-check"/> Todo entregado</span>
                    </t>
                    <t t-else="">
                        <t t-if="state.summary.done">
                            <span class="dt-badge bg-done"><t t-esc="state.summary.done"/> completada(s)</span>
                        </t>
                        <t t-if="state.summary.active">
                            <span class="dt-badge bg-active"><t t-esc="state.summary.active"/> en proceso</span>
                        </t>
                        <t t-if="state.summary.draft">
                            <span class="dt-badge bg-draft"><t t-esc="state.summary.draft"/> borrador</span>
                        </t>
                    </t>
                </div>

                <!-- Table -->
                <table class="dt-table">
                    <thead>
                        <tr>
                            <th class="dt-th-toggle"></th>
                            <th>Documento</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th class="dt-th-progress">Progreso</th>
                            <th class="dt-th-num">Demanda</th>
                            <th class="dt-th-num">Hecho</th>
                            <th>Fecha</th>
                            <th class="dt-th-action"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="state.lines" t-as="line" t-key="line.id">

                            <tr t-attf-class="dt-row #{line.state === 'done' ? 'dt-row-done' : ''}">
                                <td class="dt-td-toggle" t-on-click.stop="() => this.toggle(line.id)">
                                    <i t-attf-class="fa #{this.isOpen(line.id) ? 'fa-caret-down' : 'fa-caret-right'} dt-caret"></i>
                                </td>
                                <td class="dt-td-doc" t-on-click="() => this.openPicking(line.id)">
                                    <span class="dt-doc-link" t-esc="line.name"/>
                                </td>
                                <td>
                                    <span t-attf-class="dt-type tp-#{line.type_code}">
                                        <i t-attf-class="fa #{this.getTypeIcon(line.type_code)}"></i>
                                        <t t-esc="this.getTypeLabel(line.type_code)"/>
                                    </span>
                                </td>
                                <td>
                                    <span t-attf-class="dt-state #{this.getStateClass(line.state)}">
                                        <t t-esc="line.state_label"/>
                                    </span>
                                </td>
                                <td class="dt-td-progress">
                                    <div class="dt-bar-wrap">
                                        <div class="dt-bar">
                                            <div t-attf-class="dt-bar-fill #{this.getProgressClass(line.state)}"
                                                 t-attf-style="width:#{line.progress}%"></div>
                                        </div>
                                        <span class="dt-bar-pct"><t t-esc="line.progress"/>%</span>
                                    </div>
                                </td>
                                <td class="dt-td-num" t-esc="line.total_demand"/>
                                <td t-attf-class="dt-td-num #{line.total_done >= line.total_demand and line.total_demand > 0 ? 'dt-num-ok' : line.total_done > 0 ? 'dt-num-partial' : ''}">
                                    <t t-esc="line.total_done"/>
                                </td>
                                <td class="dt-td-date">
                                    <t t-if="line.date_done">
                                        <i class="fa fa-check-circle dt-icon-done"></i>
                                        <t t-esc="line.date_done"/>
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-calendar-o dt-icon-sched"></i>
                                        <t t-esc="line.scheduled_date"/>
                                    </t>
                                </td>
                                <td class="dt-td-action">
                                    <button class="dt-btn-open" t-on-click.stop="() => this.openPicking(line.id)" title="Abrir">
                                        <i class="fa fa-external-link"></i>
                                    </button>
                                </td>
                            </tr>

                            <!-- Expanded products -->
                            <t t-if="this.isOpen(line.id)">
                                <t t-foreach="line.products" t-as="p" t-key="p.name + '_' + p_index">
                                    <tr class="dt-sub-row">
                                        <td></td>
                                        <td class="dt-sub-product" t-att-title="p.name">
                                            <i class="fa fa-cube dt-sub-icon"></i>
                                            <t t-esc="p.name"/>
                                        </td>
                                        <td class="dt-sub-muted" t-esc="p.uom"/>
                                        <td></td>
                                        <td class="dt-td-progress">
                                            <div class="dt-bar-wrap">
                                                <div class="dt-bar dt-bar-sm">
                                                    <div t-attf-class="dt-bar-fill #{this.getProgressClass(line.state)}"
                                                         t-attf-style="width:#{p.progress}%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="dt-td-num" t-esc="p.demand"/>
                                        <td t-attf-class="dt-td-num #{p.done >= p.demand and p.demand > 0 ? 'dt-num-ok' : p.done > 0 ? 'dt-num-partial' : ''}">
                                            <t t-esc="p.done"/>
                                        </td>
                                        <td colspan="2"></td>
                                    </tr>
                                </t>
                            </t>

                        </t>
                    </tbody>
                </table>

            </t>
        </div>
    </t>

</templates>